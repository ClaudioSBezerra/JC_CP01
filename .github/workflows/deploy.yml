name: Deploy to Railway

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy API + Web to Railway
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: |
          curl -fsSL https://github.com/railwayapp/cli/releases/download/v4.30.5/railway-v4.30.5-x86_64-unknown-linux-gnu.tar.gz \
            -o /tmp/railway.tar.gz
          tar -xzf /tmp/railway.tar.gz -C /tmp/
          sudo mv /tmp/railway /usr/local/bin/railway
          railway --version

      - name: Set API environment variables
        continue-on-error: true
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway variable set \
            "DATABASE_URL=${{ secrets.DATABASE_URL }}" \
            "JWT_SECRET=${{ secrets.JWT_SECRET }}" \
            "PORT=8081" \
            "GO_ENV=production" \
            "TZ=America/Sao_Paulo" \
            --service api --skip-deploys

      - name: Deploy API
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        working-directory: backend
        run: railway up --service api --detach

      - name: Set Web environment variables
        continue-on-error: true
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway variable set \
            "API_URL=http://api.railway.internal:8081" \
            --service web --skip-deploys

      - name: Deploy Web
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        working-directory: frontend
        run: railway up --service web

      - name: Generate domain for web service
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway domain --service web 2>/dev/null || echo "Domain already exists"

      - name: Rename domain to jcinteligenc
        continue-on-error: true
        env:
          RAILWAY_ACCOUNT_TOKEN: ${{ secrets.RAILWAY_ACCOUNT_TOKEN }}
        run: |
          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $RAILWAY_ACCOUNT_TOKEN" \
            -d '{"query":"mutation { serviceDomainUpdate(input: { serviceDomainId: \"98a67b02-b5de-435b-a493-d654978c5661\", serviceId: \"c7095420-423e-4da9-b345-df52f1dd561e\", environmentId: \"bff8f416-a7f0-4110-94a9-62c532cca743\", domain: \"jcinteligenc.up.railway.app\" }) }"}' \
            https://backboard.railway.app/graphql/v2)
          echo "Response: $RESPONSE"
          echo "Deploy concluido! App em: https://jcinteligenc.up.railway.app"
