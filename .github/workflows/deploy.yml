name: Deploy to Railway

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy API + Web to Railway
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: |
          curl -fsSL https://github.com/railwayapp/cli/releases/download/v4.30.5/railway-v4.30.5-x86_64-unknown-linux-gnu.tar.gz \
            -o /tmp/railway.tar.gz
          tar -xzf /tmp/railway.tar.gz -C /tmp/
          sudo mv /tmp/railway /usr/local/bin/railway
          railway --version

      - name: Set API environment variables
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway variable set \
            "DATABASE_URL=${{ secrets.DATABASE_URL }}" \
            "JWT_SECRET=${{ secrets.JWT_SECRET }}" \
            "PORT=8081" \
            "GO_ENV=production" \
            "TZ=America/Sao_Paulo" \
            --service api --skip-deploys

      - name: Deploy API
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        working-directory: backend
        run: railway up --service api --detach

      - name: Set Web environment variables
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway variable set \
            "API_URL=http://api.railway.internal:8081" \
            --service web --skip-deploys

      - name: Deploy Web
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        working-directory: frontend
        run: railway up --service web --detach

      - name: Generate domain for web service
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway domain --service web 2>/dev/null || echo "Domain already exists"
          echo "Deploy concluido!"
